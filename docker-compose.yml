version: "3.5"
services:

    nginx:
        image: nginx:1.13.9-alpine
        depends_on:
            - php72
        networks:
            - frontend
        ports:
            - 8000:80
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./nginx/conf.d:/etc/nginx/conf.d:ro
            - ..:/app
        environment:
            # Support setting timezone through environment in image[nginx:alpine] by default
            # https://github.com/nginxinc/docker-nginx/blob/master/mainline/alpine/Dockerfile#L131
            TZ: Asia/Shanghai

    php72:
        # build: 
        #     context: ./php/build-src/7.2/fpm
        #     args:
        #         ALPINE_URL: mirror.tuna.tsinghua.edu.cn
        image: milespeng/php:7.2-fpm-alpine
        ports:
            - 9072:9000
        volumes:
            - ..:/app
            - ./php/config/ini/php.ini:/usr/local/etc/php/php.ini
            - ./php/config/ini/conf.d/opcache-recommended.ini:/usr/local/etc/php/conf.d/opcache-recommended.ini
        depends_on:
            - mysql
            - redis
        networks:
            - backend
            - frontend
        environment:
            TZ: Asia/Shanghai

    mysql:
        image: mysql:5.7.21
        networks:
            - backend
        ports:
            - 33060:3306
        volumes:
            - mysql-data:/var/lib/mysql
            - ./mysql/my.cnf:/etc/mysql/my.cnf:ro
        environment:
            TZ: Asia/Shanghai
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: laravel_indigo

    redis:
        image: redis:4.0.8-alpine
        networks:
            - frontend
        ports:
            - 63790:6379
        volumes:
            - redis-data:/data
            - ./redis/redis.conf:/redis.conf:ro
        command: ["redis-server", "/redis.conf"]

networks:
    frontend:
    backend:

volumes:
    mysql-data:
    redis-data:
